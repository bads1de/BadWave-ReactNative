# オフライン再生機能の実装計画

## 現状分析

現在のアプリケーションでは、以下の機能がすでに実装されています：

1. **OfflineStorageService**: 曲のダウンロードと管理を行うサービス
   - 曲のダウンロードと保存
   - ダウンロード済みファイルの管理
   - オンライン/オフライン状態の検出

2. **useOfflinePlayback**: オフライン再生のためのカスタムフック
   - 曲のダウンロード
   - オフライン保存パスの取得
   - オフラインストレージからの曲の削除
   - オフライン利用可能性の確認

3. **TrackPlayer**: 音楽再生のコアライブラリ
   - プレーヤーの初期化と設定
   - 再生制御
   - キュー管理
   - バックグラウンド再生

## 課題

現在の実装では、オフライン状態での再生が完全にサポートされていません。具体的には以下の課題があります：

1. **オフライン時のURLの切り替え**: オンライン時はリモートURL、オフライン時はローカルファイルパスを使用する必要がある
2. **オフライン状態の検出と対応**: アプリがオフライン状態になった時の適切な対応
3. **オフラインで利用可能な曲の表示**: ユーザーがオフラインで利用可能な曲を識別できるようにする
4. **オフライン再生時のエラーハンドリング**: ファイルが見つからない場合などのエラー処理

## 実装計画

### 1. TrackPlayerのオフライン対応

#### 1.1 TrackPlayerのURLリゾルバーの実装

```typescript
// services/TrackPlayerOfflineResolver.ts
```

- TrackPlayerに曲を追加する前に、オフライン状態を確認し、適切なURLを設定するリゾルバーを実装
- オフラインで利用可能な曲の場合はローカルファイルパスを、そうでない場合はリモートURLを使用

#### 1.2 TrackPlayerのトラック変換関数の拡張

```typescript
// hooks/TrackPlayer/utils.ts
```

- `convertSongToTrack`関数を拡張して、オフライン状態を考慮したURL解決を行う
- オフラインモードの場合、ローカルに保存されている曲のみをキューに追加する機能を追加

### 2. オフライン状態管理の強化

#### 2.1 オフライン状態管理ストアの実装

```typescript
// hooks/useOfflineStore.ts
```

- オフライン状態を管理するZustandストアを実装
- オフラインモードの有効/無効の切り替え
- オフラインで利用可能な曲のIDリストの管理

#### 2.2 オフライン状態の検出と通知

```typescript
// services/NetworkService.ts
```

- ネットワーク状態の変化を監視し、オフライン状態になった場合に適切な処理を行う
- オフライン状態になった場合、ユーザーに通知し、オフラインモードに切り替える

### 3. ユーザーインターフェースの拡張

#### 3.1 曲のダウンロード/削除UI

```typescript
// components/SongItem.tsx
```

- 曲アイテムにダウンロード/削除ボタンを追加
- ダウンロード状態の表示（ダウンロード済み、ダウンロード中、未ダウンロード）

#### 3.2 オフラインモード切替UI

```typescript
// components/OfflineModeSwitcher.tsx
```

- オフラインモードの切り替えを行うUIコンポーネント
- 現在のオフライン状態を表示

#### 3.3 オフライン利用可能な曲のフィルタリング

```typescript
// app/(tabs)/library.tsx
```

- ライブラリ画面にオフライン利用可能な曲のみを表示するフィルターを追加

### 4. データ永続化の強化

#### 4.1 オフラインデータのキャッシュ

```typescript
// lib/query-persistence-manager.ts
```

- TanStack Queryのキャッシュ機能を拡張して、オフライン時にも必要なデータを利用できるようにする
- オフラインで必要なデータを優先的にキャッシュする仕組みを実装

#### 4.2 オフライン再生履歴の管理

```typescript
// hooks/usePlayHistory.ts
```

- オフライン時の再生履歴をローカルに保存し、オンラインに戻った時に同期する機能を追加

### 5. テスト実装

#### 5.1 オフライン再生機能のユニットテスト

```typescript
// __tests__/hooks/useOfflinePlayback.test.ts
```

- オフライン再生機能のテストを拡張
- オフライン状態での曲の再生テスト
- ネットワーク状態変化時の動作テスト

#### 5.2 オフライン状態管理のユニットテスト

```typescript
// __tests__/hooks/useOfflineStore.test.ts
```

- オフライン状態管理ストアのテスト
- オフラインモード切替時の動作テスト

## 実装順序

1. TrackPlayerのオフライン対応
   - TrackPlayerのURLリゾルバーの実装
   - TrackPlayerのトラック変換関数の拡張

2. オフライン状態管理の強化
   - オフライン状態管理ストアの実装
   - オフライン状態の検出と通知

3. ユーザーインターフェースの拡張
   - 曲のダウンロード/削除UI
   - オフラインモード切替UI
   - オフライン利用可能な曲のフィルタリング

4. データ永続化の強化
   - オフラインデータのキャッシュ
   - オフライン再生履歴の管理

5. テスト実装
   - オフライン再生機能のユニットテスト
   - オフライン状態管理のユニットテスト

## 技術的な考慮事項

1. **パフォーマンス**: オフラインファイルの管理とURLの解決がパフォーマンスに影響を与えないように注意する
2. **ストレージ管理**: ダウンロードした曲のストレージ使用量を監視し、必要に応じて古いファイルを削除する機能を検討
3. **エラーハンドリング**: オフライン再生時のエラー（ファイルの破損、削除など）を適切に処理する
4. **ユーザー体験**: オフラインモードへの切り替えをシームレスに行い、ユーザー体験を損なわないようにする

## TDD実装アプローチ

TDDアプローチに従い、各機能の実装は以下の手順で進めます：

1. 機能の要件を明確にする
2. テストケースを作成する
3. テストが失敗することを確認する
4. 機能を実装する
5. テストが成功することを確認する
6. コードをリファクタリングする

各機能の実装前にテストを作成し、テストが成功することを確認してから次の機能の実装に進みます。
