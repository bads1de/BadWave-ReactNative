# 📱 オフライン再生機能の実装計画 (簡易版)

## 📋 概要

この計画書は、BadMusicApp に**曲をダウンロードし、オフラインでも再生可能にする**ための基本的な実装計画を記述したものです。オンライン/オフラインの厳密な状態管理は行いません。

## 🎯 設計方針

オフライン再生機能の設計方針として、**明示的ダウンロード方式**を採用します。

### ✅ 明示的ダウンロード方式の特徴

| 特徴                  | 説明                                                               |
| --------------------- | ------------------------------------------------------------------ |
| 👆 **ユーザー制御**   | ユーザーが明示的にダウンロードボタンを押した曲のみをオフライン保存 |
| 💾 **ストレージ管理** | ユーザーがダウンロードした曲を削除することでストレージを管理可能   |

### 🚀 将来的な拡張可能性

将来的には以下のような機能拡張も検討します（**初期実装には含めない**）：

- ⭐ お気に入りに追加した曲の自動ダウンロードオプション
- 📂 プレイリスト単位でのオフライン保存設定
- 📈 ストレージ使用量の上限設定と自動管理
- 📶 Wi-Fi 接続時のみ自動ダウンロードなどのネットワーク設定
- 🔄 オンライン/オフライン状態の自動検出とモード切替

## 🔍 現状分析

現在のアプリケーションでは、以下の機能がすでに実装されています：

### 📚 既存のコンポーネント

<table>
  <tr>
    <th>コンポーネント</th>
    <th>機能</th>
  </tr>
  <tr>
    <td rowspan="4">🎵 <strong>TrackPlayer</strong></td>
    <td>• プレーヤーの初期化と設定</td>
  </tr>
  <tr>
    <td>• 再生制御</td>
  </tr>
  <tr>
    <td>• キュー管理</td>
  </tr>
  <tr>
    <td>• バックグラウンド再生</td>
  </tr>
</table>

## ⚠️ 課題

現在の実装を基に、以下の課題を解決する必要があります：

<table>
  <tr>
    <th>課題</th>
    <th>説明</th>
    <th>優先度</th>
  </tr>
  <tr>
    <td>🔗 <strong>URL切替え</strong></td>
    <td>再生時にローカルファイルパスが存在すればそれを、なければリモートURLを使用する必要がある</td>
    <td>高</td>
  </tr>
  <tr>
    <td>👁️ <strong>視覚的表示</strong></td>
    <td>ユーザーがダウンロード済みの曲を識別できるようにする</td>
    <td>中</td>
  </tr>
  <tr>
    <td>⛔ <strong>エラー処理</strong></td>
    <td>ダウンロード失敗時や、再生時にローカルファイルが見つからない場合などのエラー処理が必要</td>
    <td>中</td>
  </tr>
  <tr>
    <td>👆 <strong>UI実装</strong></td>
    <td>曲のダウンロード/削除ボタンと、ダウンロード済み曲の表示UIの実装が必要</td>
    <td>高</td>
  </tr>
</table>

## 実装計画

### 1. TrackPlayer のオフライン対応

#### 1.1 TrackPlayer の URL リゾルバーの実装

```typescript
// services/TrackPlayerOfflineResolver.ts または hooks/TrackPlayer/utils.ts に統合
```

- TrackPlayer に曲を追加する際、ローカルにダウンロード済みのファイルがあればそのパスを、なければリモート URL を使用するリゾルバーを実装 (または既存関数内で処理)

#### 1.2 TrackPlayer のトラック変換関数の拡張

```typescript
// hooks/TrackPlayer/utils.ts
```

- `convertSongToTrack`関数を拡張し、URL リゾルバー (または同等のロジック) を使用して適切な再生パス (`track.url`) を設定する

### 2. ユーザーインターフェースの拡張

#### 2.1 曲のダウンロード/削除 UI

```typescript
// components/SongItem.tsx
```

- 曲アイテムに明示的なダウンロード/削除ボタンを追加
- ダウンロード状態の視覚的表示（ダウンロード済みか否か）

#### 2.2 ダウンロード済み曲の表示

```typescript
// app/(tabs)/downloads.tsx (新規作成または既存画面に追加)
```

- ダウンロード済みの曲一覧を表示する専用セクションまたは画面を追加
- `OfflineStorageService` からダウンロード済み曲のリスト（メタデータ含む）を取得して表示

### 3. データ永続化の強化

#### 3.1 曲メタデータのローカル保存

```typescript
// services/OfflineStorageService.ts
```

- 曲のダウンロード時に、タイトル、アーティスト、アートワーク URL などのメタデータをローカルに保存する (`OfflineStorageService` の責務)
- ダウンロード済み曲表示画面でこれらのメタデータを読み込んで使用する

### 4. テスト実装

#### 4.1 ダウンロード・再生機能のユニットテスト

```typescript
// __tests__/hooks/useOfflinePlayback.test.ts
// __tests__/services/OfflineStorageService.test.ts
```

- 曲のダウンロード、削除機能のテスト
- ダウンロードした曲がローカルパスで再生できるかのテスト (TrackPlayer 連携部分)
- メタデータが正しく保存・取得できるかのテスト

## 📍 実装順序

<table>
  <tr>
    <th>フェーズ</th>
    <th>実装内容</th>
    <th>期間目安</th>
  </tr>
  <tr>
    <td>🔥 <strong>1. TrackPlayerのオフライン対応</strong></td>
    <td>
      • TrackPlayerのURL解決ロジックの実装<br>
      • トラック変換関数の拡張
    </td>
    <td>1週目</td>
  </tr>
   <tr>
     <td>💾 <strong>2. データ永続化の強化</strong></td>
     <td>
       • 曲メタデータのローカル保存 (OfflineStorageService)
     </td>
     <td>1週目後半 - 2週目</td>
   </tr>
  <tr>
    <td>👆 <strong>3. UIの拡張</strong></td>
    <td>
      • 曲のダウンロード/削除UI<br>
      • ダウンロード済み曲の表示
    </td>
    <td>2週目 - 3週目</td>
  </tr>
  <tr>
    <td>🚨 <strong>4. テスト実装</strong></td>
    <td>
      • ダウンロード・再生機能のユニットテスト
    </td>
    <td>各フェーズで実施</td>
  </tr>
</table>

> ※ TDD アプローチに従い、各機能の実装前にテストを作成します。

## ⚙️ 技術的な考慮事項

<table>
  <tr>
    <th>考慮事項</th>
    <th>詳細</th>
    <th>対応策</th>
  </tr>
  <tr>
    <td>⚡ <strong>パフォーマンス</strong></td>
    <td>ローカルファイルの存在確認やメタデータ読み込みがパフォーマンスに影響を与える可能性</td>
    <td>効率的なファイルアクセス、非同期処理の活用</td>
  </tr>
  <tr>
    <td>💾 <strong>ストレージ管理</strong></td>
    <td>ダウンロードした曲のストレージ使用量の管理</td>
    <td>ユーザーによる手動削除。将来的には使用量表示や警告機能を追加検討。</td>
  </tr>
  <tr>
    <td>⛔ <strong>エラー処理</strong></td>
    <td>ダウンロード失敗、再生時のファイル欠損、ストレージ容量不足など</td>
    <td>適切なエラーハンドリングとユーザーへのフィードバック</td>
  </tr>
  <tr>
    <td>🚀 <strong>ユーザー体験</strong></td>
    <td>ダウンロード/削除操作の分かりやすさ、ダウンロード済み曲へのアクセスしやすさ</td>
    <td>直感的なUIデザイン</td>
  </tr>
  <tr>
    <td>🔋 <strong>バッテリー消費</strong></td>
    <td>ダウンロード処理によるバッテリー消費</td>
    <td>バックグラウンドダウンロードの最適化（必要であれば）</td>
  </tr>
</table>

## 🧪 TDD 実装アプローチ

<table>
  <tr>
    <th>ステップ</th>
    <th>内容</th>
    <th>目的</th>
  </tr>
  <tr>
    <td>📝 <strong>1. 要件定義</strong></td>
    <td>機能の要件を明確にする</td>
    <td>実装の方向性と目標を明確にする</td>
  </tr>
  <tr>
    <td>🧪 <strong>2. テスト作成</strong></td>
    <td>テストケースを作成する</td>
    <td>期待される動作を明確にする</td>
  </tr>
  <tr>
    <td>❌ <strong>3. テスト失敗確認</strong></td>
    <td>テストが失敗することを確認する</td>
    <td>テストが正しく機能していることを確認</td>
  </tr>
  <tr>
    <td>💻 <strong>4. 実装</strong></td>
    <td>機能を実装する</td>
    <td>テストをパスする最小限の実装を行う</td>
  </tr>
  <tr>
    <td>✅ <strong>5. テスト成功確認</strong></td>
    <td>テストが成功することを確認する</td>
    <td>実装が要件を満たしていることを確認</td>
  </tr>
  <tr>
    <td>🔄 <strong>6. リファクタリング</strong></td>
    <td>コードをリファクタリングする</td>
    <td>コードの品質と保守性を向上させる</td>
  </tr>
</table>

> 各機能の実装前にテストを作成し、テストが成功することを確認してから次の機能の実装に進みます。
