# ローカルファースト（Local-First）実装計画

## 概要

Windows 版で採用した「ローカル DB（SQLite）主導のデータ管理」をモバイル版にも導入し、Spotify のような高速なレスポンスと、Apple Music のような堅牢なオフライン再生を実現します。

### 基本方針

1. **読み込みはローカル優先**: UI がデータを取得する際、まずローカルの SQLite から読み込みます（レイテンシゼロ）。
2. **バックグラウンド同期**: Supabase からのデータ取得はバックグラウンドで行い、ローカル DB を更新（Upsert）します。
3. **アセットのローカル管理**: 楽曲ファイル（MP3）はファイルシステムに保存し、そのパスを SQLite で管理します。

---

## 市場調査：主要サービスのオフライン戦略

### Spotify

- **メタデータの高速表示**: 起動時に全メタデータを SQLite 等にキャッシュ済みの状態から読み込むため、数千曲あっても一瞬で表示される。
- **ダウンロードの「隠蔽」**: ストリーミング中も自動的にキャッシュを行い、ユーザーが意識せずにオフラインで聴ける曲を増やしている。
- **30 日ルール**: サブスクリプション確認のため、30 日に 1 回はサーバーとの通信を必須とする。

### Apple Music

- **FairPlay DRM**: ダウンロードされたファイルは暗号化され、OS レベルのライブラリ（MusicKit）経由でしか再生できない。
- **ライブラリの抽象化**: クラウド上のライブラリとローカル保存分をシームレスに統合。

---

## 実装フェーズ

### フェーズ 1: SQLite & Drizzle ORM のセットアップ

現状の JSON（MMKV）ベースのメタデータ管理を、リレーショナル DB に移行します。

- **依存関係の追加**:
  - `expo-sqlite`
  - `drizzle-orm`
  - `drizzle-kit`（開発用）
- **DB 初期化**:
  - `lib/db/client.ts`: SQLite 接続の構築。
  - `lib/db/schema.ts`: `songs`, `playlists`, `liked_songs` のテーブル定義。

### フェーズ 2: ローカルファースト・データフローの構築

データ取得の向きを「API -> UI」から「Local DB -> UI」に変更します。

- **読み込みフック (`useGet...`)**:
  - `hooks/data/useGetSongs.ts`: SQLite をソースとしてデータを取得。
- **同期フック (`useSync...`)**:
  - `hooks/sync/useSyncSongs.ts`: Supabase から最新の差分（`updated_at`以降）を取得し、SQLite に Upsert。
  - 成功時に React Query のキャッシュを invalidate し、UI を更新。

### フェーズ 3: オフライン・アセット管理

楽曲ファイルのダウンロードと再生ロジックを統合します。

- **ダウンロード管理**:
  - `expo-file-system` を使用し、MP3 ファイルを保存。
  - SQLite の `songs` テーブルに `local_path` カラムを追加し、保存済みかどうかを判定。
- **プレイヤーの修正**:
  - `useAudioPlayer` が曲を再生する際、`local_path` があればそれを使い、なければストリーミング URL を使用する。

### フェーズ 4: 同期キュー（Action Queue）の実装

オフライン時の書き込み操作（「いいね」、プレイリスト編集）を保証します。

- **キューの実装**:
  - オフライン中の操作を SQLite の `sync_queue` テーブルに保存。
- **自動同期**:
  - `NetInfo` で接続を検知した際、溜まっているキューを順番に実行（Supabase へ送信）。

### フェーズ 5: オフライン専用 UI & UX

オフラインであることをユーザーに適切に伝え、混乱を防ぎます。

- **オフラインモード**:
  - 検索やトレンドなど、オンライン必須機能の「制限状態」表示。
- **ダウンロード済み専用ライブラリ**:
  - 手動でダウンロードした曲のみを表示するフィルタリング機能。

---

## 期待される効果

- **表示速度**: ネットワーク状態に関わらず、ライブラリ画面が瞬時に表示される（SWR の究極形）。
- **オフライン体験**: 飛行機内や地下鉄でも、ダウンロード済み楽曲を完全にシームレスに再生。
- **開発効率**: Windows 版とデータモデルを共通化することで、ビジネスロジックの移植が容易になる。
