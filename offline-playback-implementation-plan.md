# 📱 オフライン再生機能の実装計画

## 📋 概要

この計画書は、BadMusicApp にオフライン再生機能を追加するための実装計画を詳細に記述したものです。

## 🎯 設計方針

オフライン再生機能の設計方針として、**明示的ダウンロード方式**を採用します。

### ✅ 明示的ダウンロード方式の特徴

| 特徴                  | 説明                                                               |
| --------------------- | ------------------------------------------------------------------ |
| 👆 **ユーザー制御**   | ユーザーが明示的にダウンロードボタンを押した曲のみをオフライン保存 |
| 🔄 **再生制限**       | オフラインモードでは、ダウンロード済みの曲のみ再生可能             |
| 💾 **ストレージ管理** | ユーザーがストレージ使用量を完全に制御可能                         |
| 📊 **データ通信量**   | データ通信量の管理がしやすい                                       |

### 🚀 将来的な拡張可能性

将来的には以下のような機能拡張も検討します（**初期実装には含めない**）：

- ⭐ お気に入りに追加した曲の自動ダウンロードオプション
- 📂 プレイリスト単位でのオフライン保存設定
- 📈 ストレージ使用量の上限設定と自動管理
- 📶 Wi-Fi 接続時のみ自動ダウンロードなどのネットワーク設定

## 🔍 現状分析

現在のアプリケーションでは、以下の機能がすでに実装されています：

### 📚 既存のコンポーネント

<table>
  <tr>
    <th>コンポーネント</th>
    <th>機能</th>
  </tr>
  <tr>
    <td rowspan="3">💾 <strong>OfflineStorageService</strong></td>
    <td>• 曲のダウンロードと保存</td>
  </tr>
  <tr>
    <td>• ダウンロード済みファイルの管理</td>
  </tr>
  <tr>
    <td>• オンライン/オフライン状態の検出</td>
  </tr>
  <tr>
    <td rowspan="4">🔊 <strong>useOfflinePlayback</strong></td>
    <td>• 曲のダウンロード</td>
  </tr>
  <tr>
    <td>• オフライン保存パスの取得</td>
  </tr>
  <tr>
    <td>• オフラインストレージからの曲の削除</td>
  </tr>
  <tr>
    <td>• オフライン利用可能性の確認</td>
  </tr>
  <tr>
    <td rowspan="4">🎵 <strong>TrackPlayer</strong></td>
    <td>• プレーヤーの初期化と設定</td>
  </tr>
  <tr>
    <td>• 再生制御</td>
  </tr>
  <tr>
    <td>• キュー管理</td>
  </tr>
  <tr>
    <td>• バックグラウンド再生</td>
  </tr>
</table>

## ⚠️ 課題

現在の実装では、オフライン状態での再生が完全にサポートされていません。以下の課題を解決する必要があります：

<table>
  <tr>
    <th>課題</th>
    <th>説明</th>
    <th>優先度</th>
  </tr>
  <tr>
    <td>🔗 <strong>URL切替え</strong></td>
    <td>オンライン時はリモートURL、オフライン時はローカルファイルパスを使用する必要がある</td>
    <td>高</td>
  </tr>
  <tr>
    <td>📶 <strong>オフライン検出</strong></td>
    <td>アプリがオフライン状態になった時の適切な対応が必要</td>
    <td>高</td>
  </tr>
  <tr>
    <td>👁️ <strong>視覚的表示</strong></td>
    <td>ユーザーがオフラインで利用可能な曲を識別できるようにする</td>
    <td>中</td>
  </tr>
  <tr>
    <td>⛔ <strong>エラー処理</strong></td>
    <td>ファイルが見つからない場合などのエラー処理が必要</td>
    <td>中</td>
  </tr>
  <tr>
    <td>👆 <strong>UI実装</strong></td>
    <td>曲のダウンロード/削除を行うUIの実装が必要</td>
    <td>高</td>
  </tr>
</table>

## 実装計画

### 1. TrackPlayer のオフライン対応

#### 1.1 TrackPlayer の URL リゾルバーの実装

```typescript
// services/TrackPlayerOfflineResolver.ts
```

- TrackPlayer に曲を追加する前に、オフライン状態を確認し、適切な URL を設定するリゾルバーを実装
- オフラインで利用可能な曲の場合はローカルファイルパスを、そうでない場合はリモート URL を使用
- オフラインモード時に未ダウンロードの曲は再生不可とする明確なエラーハンドリング

#### 1.2 TrackPlayer のトラック変換関数の拡張

```typescript
// hooks/TrackPlayer/utils.ts
```

- `convertSongToTrack`関数を拡張して、オフライン状態を考慮した URL 解決を行う
- オフラインモードの場合、ローカルに保存されている曲のみをキューに追加する機能を追加
- 明示的にダウンロードされた曲のみを対象とする

### 2. オフライン状態管理の強化

#### 2.1 オフライン状態管理ストアの実装

```typescript
// hooks/useOfflineStore.ts
```

- オフライン状態を管理する Zustand ストアを実装
- オフラインモードの有効/無効の切り替え
- 明示的にダウンロードされた曲の ID リストの管理
- ダウンロード進行状況の管理（ダウンロード中、完了、エラーなど）

#### 2.2 オフライン状態の検出と通知

```typescript
// services/NetworkService.ts
```

- ネットワーク状態の変化を監視し、オフライン状態になった場合に適切な処理を行う
- オフライン状態になった場合、ユーザーに通知し、オフラインモードに切り替える

### 3. ユーザーインターフェースの拡張

#### 3.1 曲のダウンロード/削除 UI

```typescript
// components/SongItem.tsx
```

- 曲アイテムに明示的なダウンロード/削除ボタンを追加
- ダウンロード状態の視覚的表示（ダウンロード済み、ダウンロード中、未ダウンロード）
- ダウンロード進行状況のインジケーター
- オフラインで利用可能な曲の視覚的な区別

#### 3.2 オフラインモード切替 UI

```typescript
// components/OfflineModeSwitcher.tsx
```

- オフラインモードの切り替えを行う UI コンポーネント
- 現在のオフライン状態を表示
- オフラインモード時の制限事項をユーザーに明示
- ネットワーク状態の自動検出と表示

#### 3.3 オフライン利用可能な曲のフィルタリングとダウンロード管理

```typescript
// app/(tabs)/library.tsx
// app/(tabs)/downloads.tsx
```

- ライブラリ画面にオフライン利用可能な曲のみを表示するフィルターを追加
- ダウンロード済み曲の専用セクションまたは画面の追加
- ダウンロード管理画面（一括削除、ストレージ使用量表示など）

### 4. データ永続化の強化

#### 4.1 オフラインデータのキャッシュ

```typescript
// lib/query-persistence-manager.ts
```

- TanStack Query のキャッシュ機能を拡張して、オフライン時にも必要なデータを利用できるようにする
- オフラインで必要なデータを優先的にキャッシュする仕組みを実装

#### 4.2 オフライン再生履歴の管理

```typescript
// hooks/usePlayHistory.ts
```

- オフライン時の再生履歴をローカルに保存し、オンラインに戻った時に同期する機能を追加

### 5. テスト実装

#### 5.1 オフライン再生機能のユニットテスト

```typescript
// __tests__/hooks/useOfflinePlayback.test.ts
```

- オフライン再生機能のテストを拡張
- オフライン状態での曲の再生テスト
- ネットワーク状態変化時の動作テスト

#### 5.2 オフライン状態管理のユニットテスト

```typescript
// __tests__/hooks/useOfflineStore.test.ts
```

- オフライン状態管理ストアのテスト
- オフラインモード切替時の動作テスト

## 📍 実装順序

<table>
  <tr>
    <th>フェーズ</th>
    <th>実装内容</th>
    <th>期間目安</th>
  </tr>
  <tr>
    <td>🔥 <strong>1. TrackPlayerのオフライン対応</strong></td>
    <td>
      • TrackPlayerのURLリゾルバーの実装<br>
      • トラック変換関数の拡張
    </td>
    <td>1週目</td>
  </tr>
  <tr>
    <td>💾 <strong>2. オフライン状態管理の強化</strong></td>
    <td>
      • オフライン状態管理ストアの実装<br>
      • オフライン状態の検出と通知
    </td>
    <td>2週目</td>
  </tr>
  <tr>
    <td>👆 <strong>3. UIの拡張</strong></td>
    <td>
      • 曲のダウンロード/削除UI<br>
      • オフラインモード切替UI<br>
      • オフライン利用可能な曲のフィルタリング
    </td>
    <td>3週目</td>
  </tr>
  <tr>
    <td>📚 <strong>4. データ永続化の強化</strong></td>
    <td>
      • オフラインデータのキャッシュ<br>
      • オフライン再生履歴の管理
    </td>
    <td>4週目</td>
  </tr>
  <tr>
    <td>🚨 <strong>5. テスト実装</strong></td>
    <td>
      • オフライン再生機能のユニットテスト<br>
      • オフライン状態管理のユニットテスト
    </td>
    <td>各フェーズで実施</td>
  </tr>
</table>

> ※ TDD アプローチに従い、各機能の実装前にテストを作成します。

## ⚙️ 技術的な考慮事項

<table>
  <tr>
    <th>考慮事項</th>
    <th>詳細</th>
    <th>対応策</th>
  </tr>
  <tr>
    <td>⚡ <strong>パフォーマンス</strong></td>
    <td>オフラインファイルの管理とURLの解決がパフォーマンスに影響を与える可能性</td>
    <td>キャッシュ戦略の最適化、非同期処理の活用</td>
  </tr>
  <tr>
    <td>💾 <strong>ストレージ管理</strong></td>
    <td>ダウンロードした曲のストレージ使用量の管理</td>
    <td>使用量の表示、警告機能、自動クリーンアップオプション</td>
  </tr>
  <tr>
    <td>⛔ <strong>エラー処理</strong></td>
    <td>オフライン再生時のエラー（ファイルの破損、削除など）</td>
    <td>引用整合性チェック、リトライ機能、ユーザー通知</td>
  </tr>
  <tr>
    <td>🚀 <strong>ユーザー体験</strong></td>
    <td>明示的ダウンロード方式でありながらの使いやすさ</td>
    <td>直感的なUI、進行状況の表示、バックグラウンド処理</td>
  </tr>
  <tr>
    <td>🔋 <strong>バッテリー消費</strong></td>
    <td>ダウンロード処理によるバッテリー消費</td>
    <td>バッチ処理、バッテリー状態に応じた制御</td>
  </tr>
  <tr>
    <td>📶 <strong>データ使用量</strong></td>
    <td>モバイルデータ使用量の管理</td>
    <td>Wi-Fi接続時のみダウンロードするオプション</td>
  </tr>
</table>

## 🧪 TDD 実装アプローチ

<table>
  <tr>
    <th>ステップ</th>
    <th>内容</th>
    <th>目的</th>
  </tr>
  <tr>
    <td>📝 <strong>1. 要件定義</strong></td>
    <td>機能の要件を明確にする</td>
    <td>実装の方向性と目標を明確にする</td>
  </tr>
  <tr>
    <td>🧪 <strong>2. テスト作成</strong></td>
    <td>テストケースを作成する</td>
    <td>期待される動作を明確にする</td>
  </tr>
  <tr>
    <td>❌ <strong>3. テスト失敗確認</strong></td>
    <td>テストが失敗することを確認する</td>
    <td>テストが正しく機能していることを確認</td>
  </tr>
  <tr>
    <td>💻 <strong>4. 実装</strong></td>
    <td>機能を実装する</td>
    <td>テストをパスする最小限の実装を行う</td>
  </tr>
  <tr>
    <td>✅ <strong>5. テスト成功確認</strong></td>
    <td>テストが成功することを確認する</td>
    <td>実装が要件を満たしていることを確認</td>
  </tr>
  <tr>
    <td>🔄 <strong>6. リファクタリング</strong></td>
    <td>コードをリファクタリングする</td>
    <td>コードの品質と保守性を向上させる</td>
  </tr>
</table>

> 各機能の実装前にテストを作成し、テストが成功することを確認してから次の機能の実装に進みます。

## 👤 ユーザーストーリー

<table>
  <tr>
    <th>ストーリー</th>
    <th>詳細</th>
    <th>価値</th>
  </tr>
  <tr>
    <td>💾 <strong>曲のダウンロード</strong></td>
    <td>ユーザーとして、曲を明示的にダウンロードできるようにしたい</td>
    <td>オフライン時に聴きたい曲を事前に準備できる</td>
  </tr>
  <tr>
    <td>👁️ <strong>視覚的識別</strong></td>
    <td>ユーザーとして、ダウンロード済みの曲を視覚的に識別したい</td>
    <td>オフライン時に再生可能な曲がわかる</td>
  </tr>
  <tr>
    <td>🔍 <strong>フィルタリング</strong></td>
    <td>ユーザーとして、ダウンロード済みの曲のみを表示するフィルターを使いたい</td>
    <td>オフライン時に利用可能なコンテンツを簡単に見つけられる</td>
  </tr>
  <tr>
    <td>🗑️ <strong>曲の削除</strong></td>
    <td>ユーザーとして、不要になったダウンロード済みの曲を削除したい</td>
    <td>ストレージ容量を管理できる</td>
  </tr>
  <tr>
    <td>📱 <strong>モード切替</strong></td>
    <td>ユーザーとして、オフラインモードを手動で切り替えたい</td>
    <td>データ通信量を節約できる</td>
  </tr>
</table>
