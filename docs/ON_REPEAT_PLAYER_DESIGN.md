# OnRepeat Player 機能設計書

## 1. 概要

**OnRepeat Player** は、ユーザーが「よく聴く曲（OnRepeat）」を素早くプレビューし、お気に入りの曲を再発見できる Spotify 風のショートプレビュー機能です。

TikTok/Reels/Spotify のプレビュー機能にインスパイアされた、縦スワイプ型の全画面プレビュー体験を提供します。

### 1.1 目的

- ユーザーがよく聴く曲を短時間で振り返り・試聴できるようにする
- 曲の発見（ディスカバリー）体験を向上させる
- アプリのエンゲージメントを高める

### 1.2 対象コンテンツ

| コンテンツタイプ   | 対応 | 備考                                  |
| ------------------ | ---- | ------------------------------------- |
| **音声のみ（曲）** | ✅   | アルバムアートを背景に表示            |
| **動画付きの曲**   | ✅   | 動画をループ再生（Spotlights と同様） |

---

## 2. ユーザーストーリー

1. ユーザーとして、OnRepeat セクションの曲をタップしたら、その曲から OnRepeat Player モードに入りたい。
2. ユーザーとして、縦にスワイプして次/前の曲に移動したい。
3. ユーザーとして、気に入った曲を「いいね」したり、プレイリストに追加したい。
4. ユーザーとして、「フルで聴く」ボタンでメインプレイヤーに曲を渡して再生を続けたい。
5. ユーザーとして、下にスワイプダウンまたは「×」ボタンで OnRepeat Player を閉じたい。

---

## 3. UI/UX デザイン

### 3.1 画面構成

```
┌─────────────────────────────────────────┐
│  ← (閉じるボタン)                        │
│                                         │
│                                         │
│     ┌───────────────────────────┐       │
│     │                           │       │
│     │   [アルバムアート/動画]    │       │
│     │                           │       │
│     └───────────────────────────┘       │
│                                         │
│         曲タイトル                       │
│         アーティスト名                   │
│                                         │
│   ─────────────────────────────────     │  ← プログレスバー
│                                         │
│   [❤️ いいね] [➕ 追加] [▶️ フルで聴く]   │  ← アクションボタン
│                                         │
└─────────────────────────────────────────┘
```

### 3.2 インタラクション

| ジェスチャー    | アクション                     |
| --------------- | ------------------------------ |
| 上スワイプ      | 次の曲へ                       |
| 下スワイプ      | 前の曲へ（先頭の場合は閉じる） |
| タップ（画像）  | 再生/一時停止                  |
| 左上「←」タップ | 閉じる                         |

### 3.3 ビジュアル

- **背景**: アルバムアートのブラー + 暗めのグラデーション
- **コンテンツ**: 中央にアルバムアート（角丸）または動画（動画がある場合）
- **テキスト**: 白文字 + シャドウ
- **プログレスバー**: 薄紫（#a78bfa）、アニメーション付き
- **アクションボタン**: ガラスモーフィズム風のボタン

---

## 4. 技術設計

### 4.1 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      OnRepeatPlayer                          │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    OnRepeatPlayerList                   ││
│  │  (FlashList - 縦スワイプ)                               ││
│  │  ┌─────────────────────────────────────────────────────┐││
│  │  │               OnRepeatPlayerItem                    │││
│  │  │  - useOnRepeatPlayer (音声/動画の再生制御)           │││
│  │  │  - OnRepeatPlayerControls (アクションボタン群)       │││
│  │  └─────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 4.2 ディレクトリ構成

```
components/
├── onRepeat/
│   ├── OnRepeat.tsx                 # ホーム画面セクション
│   └── player/
│       ├── OnRepeatPlayer.tsx       # メイン画面（Modal or 全画面）
│       ├── OnRepeatPlayerList.tsx   # FlashListラッパー
│       ├── OnRepeatPlayerItem.tsx   # 1曲分のUI
│       └── OnRepeatPlayerControls.tsx # アクションボタン群

hooks/
├── useOnRepeatPlayer.ts             # 音声/動画再生制御フック
├── stores/
│   └── useOnRepeatStore.ts          # Zustand状態管理
```

---

## 5. データフロー

### 5.1 OnRepeat Player を開く

```
[ユーザー: OnRepeatのカードをタップ]
    ↓
[OnRepeat: handleSongPress(index)]
    ↓
[OnRepeatStore: open(songs, index)]
    ↓
[OnRepeatPlayer: isVisible=true → 表示]
    ↓
[OnRepeatPlayerList: currentIndexにスクロール]
    ↓
[OnRepeatPlayerItem: isVisible=true → 再生開始]
```

### 5.2 スワイプで曲を切り替える

```
[ユーザー: 上スワイプ]
    ↓
[FlashList: onViewableItemsChanged]
    ↓
[OnRepeatStore: setCurrentIndex(newIndex)]
    ↓
[旧OnRepeatPlayerItem: isVisible=false → 一時停止]
[新OnRepeatPlayerItem: isVisible=true → 再生開始]
```

### 5.3 フルで聴く

```
[ユーザー: 「フルで聴く」ボタンをタップ]
    ↓
[OnRepeatPlayerControls: handlePlayFull]
    ↓
[OnRepeatStore: close()]
    ↓
[TrackPlayer: キューに追加して再生]
    ↓
[PlayerStore: showPlayer=true]
```

---

## 9. 成功指標

- **安定性**: 曲をタップした時に、必ず正しい曲が再生される
- **パフォーマンス**: 100 曲スワイプしてもメモリリークや遅延がない
- **UX**: Spotify や TikTok に匹敵するスムーズな操作感
