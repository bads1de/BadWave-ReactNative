# リール機能 実装計画書 (簡易版)

## 1. エグゼクティブサマリー

### 概要

既存の「Spotlight」機能（横スクロール）を廃止し、新たに TikTok や Instagram リールのような**縦スクロール形式のショート動画機能「Reels」**を実装する。

### 主要な変更点

- **新しいタブの追加**: アプリの主要ナビゲーションを「Home」「Search」「Library」に**「Reels」**を加えた 4 タブ構成に変更する。
- **機能の配置**: Reels は独立した専用タブとして提供し、没入感のある動画体験を実現する。
- **既存機能の廃止**: ホーム画面の`SpotlightBoard`および関連するモーダル、テストコードを**完全に削除**し、コードベースを簡素化する。
- **技術選定**: 動画再生には実績のある`expo-video`と`useVideoPlayer`フックを活用する。データは既存の`getSpotlights`アクションを再利用する。

### 実装フェーズ (概要)

- **Phase 1 (本計画)**: Reels タブの UI と動画再生機能を実装する。この段階では、いいね等の**アクションボタンは UI のみ（非機能）**とする。
- **Phase 2 (将来構想)**: バックエンドの DB スキーマを拡張し、アクションボタン（いいね、ダウンロード等）の機能を実装する。

---

## 2. UI/UX 設計

### 新しいタブ構成

```
┌─────────────────────────────────────────────────┐
│  ○ Home    ○ Search    ○ Library    ○ Reels    │
└─────────────────────────────────────────────────┘
```

### リール画面レイアウト

フルスクリーンの動画を背景に、アーティスト情報やアクションボタンを配置する。動画への没入感を高めるため、**Reels タブの再生画面ではアプリの共通ヘッダーを非表示にします。**

```
┌─────────────────────────────┐
│                             │
│     [ショート動画再生中]       │
│                             │
│  ┌───────────────────┐      │
│  │ アーティスト名      │      │
│  │ 曲のタイトル        │      │
│  └───────────────────┘      │
│                        ❤️   │ ← アクションボタン
│                        ⬇️   │
│                        ➕   │
│                        ⋯   │
└─────────────────────────────┘
```

### アクションボタンの仕様 (Phase 1)

**重要**: Phase 1 では、ユーザーアクション（いいね、ダウンロード、プレイリスト追加など）のバックエンド機能が存在しないため、すべてのアクションボタンは**"飾り"**として実装する。

- **状態**: `disabled={true}` とし、押しても何も起きない。
- **見た目**: 非アクティブであることがわかるように、少し透明度を下げる (`opacity: 0.6`)。
- **理由**: 先に UI の全体像を完成させ、将来の機能実装をスムーズにするため。

---

## 3. アーキテクチャと実装方針

### ファイル構成

`Reels`機能に関連するコンポーネントやフックは、以下の場所に新規作成する。

```
badwave-mobile/
├── app/(tabs)/
│   └── reels.tsx             # 新規: Reelsタブのメイン画面
├── components/
│   └── reels/                # 新規: Reels関連コンポーネント
│       ├── ReelsList.tsx
│       └── ReelItem.tsx
└── hooks/
    └── useReelsPlayer.ts     # 新規: 動画再生ロジックを管理
```

### データフロー

1. **データ取得**: `ReelsScreen`が`@tanstack/react-query`を使い、既存の`getSpotlights`アクションを呼び出す。
2. **データ表示**: 取得した`Spotlight`型のデータを`FlatList`でレンダリングする。`Spotlight`型から`Song`型への**データ変換は行わない**。
3. **動画再生**: `expo-video`が`Spotlight`データ内の`video_path`を直接利用して動画を再生する。

### 動画再生とユーザー操作

- **再生ライブラリ**: `expo-video`の`useVideoPlayer`フックを使用し、動画の再生・一時停止を制御する。
- **再生動作**: 各動画の再生が終了すると、**次の動画が自動的に再生**されます。ユーザーが上下に**スワイプ**することでも、前後の動画へ移動できます。
- **縦スクロール**: `FlatList`コンポーネントを使い、1 画面単位のスクロール（`pagingEnabled`）を実現する。
- **パフォーマンス最適化**:
  - **仮想化**: `FlatList`の標準機能により、表示範囲外のアイテムはレンダリングしない。
  - **動画プリロード**: ユーザーのスクロール操作を予測し、表示される前後の動画をバックグラウンドで読み込む (`windowSize`プロパティを活用)。
  - **コンポーネントのメモ化**: `React.memo`を使い、不要な再レンダリングを防ぐ。

### プレイヤーの連携とタブ切り替え

- **排他制御**: **Reels 再生中は、再生中の他の曲（TrackPlayer）を一時停止し、画面下部のミニプレイヤーも非表示にします。**
- **シームレスな復帰**: `Reels`タブから他のタブへ切り替えて戻ってきた際には、**離れた時点の動画から再生を再開**し、シームレスな体験を提供します。スクロール位置も維持されます。

---

## 4. 既存機能からの移行計画

### 削除対象ファイル

- `components/board/SpotlightBoard.tsx`
- `components/modal/SpotlightModal.tsx`
- `__tests__/components/board/SpotlightBoard.test.tsx`
- `__tests__/components/modal/SpotlightModal.test.tsx`

### 変更対象ファイル

- `app/(tabs)/index.tsx`: `SpotlightBoard`コンポーネントのインポートと呼び出しを削除する。
- `app/(tabs)/_layout.tsx`: 新しい`reels`スクリーンをタブナビゲーションに追加する。

---

## 5. テスト戦略

TDD（テスト駆動開発）に準拠し、以下の観点でテストを実装する。

- **ユニットテスト**:
  - 各コンポーネント (`ReelItem`など) が正しく表示されること。
  - カスタムフック (`useReelsPlayer`) が動画再生ロジックを正しく制御すること。
  - アクションボタンが`disabled`状態であること。
- **統合テスト**:
  - `Reels`タブにデータが読み込まれ、リストが表示されること。
  - リストをスクロールすると、次の動画が自動再生されること。
  - 他のタブに切り替えた際に、動画の再生が停止すること。
- **パフォーマンス/E2E テスト**:
  - スクロールが 60fps を維持できること。
  - メモリリークが発生しないこと。

---

## 6. 主要なリスクと対策

| リスク                                                    | 対策                                                                                                                               |
| :-------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------- |
| **パフォーマンス劣化** (スクロールのカクつき、メモリ不足) | `FlatList`の最適化設定 (`windowSize`, `removeClippedSubviews`) を徹底し、動画のプリロード範囲を適切に管理する。                    |
| **動画プレイヤーと音楽プレイヤーの競合**                  | `Reels`タブの表示状態をトリガーに、音楽プレイヤー(`TrackPlayer`)を明示的に一時停止・再開する排他制御を行う。                       |
| **既存`Spotlight`機能の削除漏れによるバグ**               | 削除対象ファイルをリスト化し、プルリクエスト時に CI でファイル存在チェックやビルド検証を自動実行する。                             |
| **アクションボタンが機能しないことによるユーザーの混乱**  | ボタンの見た目を非アクティブ風にし、将来的にはツールチップで「近日公開」と表示することも検討する。リリースノートで仕様を明記する。 |

---

**最終更新**: 2025-01-18 (レビュー用に簡略化)
**バージョン**: 3.0
